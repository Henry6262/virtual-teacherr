<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Courses</title>
    <link rel="stylesheet" href="../static/css/page-skeleton-styles.css" th:href="@{/css/page-skeleton-styles.css}">
    <link rel="stylesheet" href="../static/css/user-wallet-styles.css" th:href="@{/css/user-wallet-styles.css}">
    <link rel="stylesheet" href="../static/css/wallet-icon-styles.css" th:href="@{/css/wallet-icon-styles.css}">
    <link rel="stylesheet" href="../static/css/pagination-arrows-styles.css" th:href="@{/css/pagination-arrows-styles.css}">
    <link rel="stylesheet" href="../static/css/transaction-modal-styles.css" th:href="@{/css/transaction-modal-styles.css}">
    <link rel="stylesheet" href="../static/css/confirmation-button-styles.css" th:href="@{/css/confirmation-button-styles.css}">
    <link rel="stylesheet" href="../static/css/loading-spinner-styles.css" th:href="@{/css/loading-spinner-styles.css}">


    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css' integrity='sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ' crossorigin='anonymous'>
    <script src="https://kit.fontawesome.com/4083de25cb.js" crossorigin="anonymous"></script>
</head>

<body class="body">

<div id="content">
    <header class="side-header">

        <small id="user-id" style="visibility: hidden; z-index: 0;" th:text="${userId}"></small>

        <a href="#">
            <div class="logo">
                <img th:unless="${userPicture == null}" class="user_image" src="#" th:src="${defaultProfilePic}">
                <img th:unless="${userPicture == null}" class="user_image" src="#" th:src="${userPicture}">
            </div>
        </a>

        <nav class="navbar-side">
            <ul>
                <li><a class="li-icons" th:href="@{/}" href="#">
                    <div  class="svg-space icons"><i class="fa-solid fa-bag-shopping icon"></i></div>Browse</a>
                </li>
                <li class="active"><a class="li-icons" href="#" th:href="@{/courses/enrolled}">
                    <div  class="svg-space icons"><i class="fa-solid fa-book icon"></i></div>My Courses</a>
                </li>
                <li><a class="li-icons" th:href="@{/wallets/my-wallet}" href="#">
                    <div class="svg-space icons"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 64 80" enable-background="new 0 0 64 64" xml:space="preserve"><g><g><g><path d="M57,51H7V21h50V51z M9,49h46V23H9V49z"/></g><g><path d="M29.7,23H7V13h19.7L29.7,23z M9,21h18.1l-1.8-6H9V21z"/></g></g></g></svg></div> Labs</a>
                </li>
                <li><a class="li-icons" href="#" th:href="@{/users/profile}">
                    <div class="svg-space icons"><i class="fa-solid fa-user-graduate icon"></i></div>Profile</a>
                </li>

                <li class="bottom"><a href="#">
                    <div class="svg-space"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 64 80" enable-background="new 0 0 64 64" xml:space="preserve"><g><g><g><path d="M35.9,57.1h-7.8l-0.6-6.6c-1.9-0.5-3.6-1.2-5.3-2.2L17,52.5L11.5,47l4.2-5.2c-1-1.6-1.7-3.4-2.2-5.3l-6.6-0.6v-7.8     l6.6-0.6c0.5-1.8,1.2-3.6,2.2-5.3L11.5,17l5.5-5.5l5.2,4.2c1.6-1,3.4-1.7,5.3-2.2l0.6-6.6h7.8l0.6,6.6c1.9,0.5,3.6,1.2,5.3,2.2     l5.2-4.2l5.5,5.5l-4.2,5.2c1,1.6,1.7,3.4,2.2,5.3l6.6,0.6v7.8l-6.6,0.6c-0.5,1.8-1.2,3.6-2.2,5.3l4.2,5.2L47,52.5l-5.2-4.2     c-1.6,1-3.4,1.7-5.3,2.2L35.9,57.1z M29.9,55.1h4.2l0.6-6.4h0.8c2.1-0.4,4-1.2,5.8-2.4l0.6-0.4l4.9,4l3-3l-4-4.9l0.4-0.6     c1.2-1.8,2-3.7,2.4-5.8v-0.8l0.9-0.1l5.5-0.5v-4.2l-6.4-0.6v-0.8c-0.4-2.1-1.2-4-2.4-5.8L45.8,22l4-4.9l-3-3l-4.9,4l-0.6-0.4     c-1.8-1.2-3.7-2-5.8-2.4h-0.8l-0.1-0.9l-0.5-5.5h-4.2l-0.6,6.4h-0.8c-2.1,0.4-4,1.2-5.8,2.4L22,18.2l-4.9-4l-3,3l4,4.9l-0.4,0.6     c-1.2,1.8-2,3.7-2.4,5.8v0.8l-0.9,0.1l-5.5,0.5v4.2l6.4,0.6v0.8c0.4,2.1,1.2,4,2.4,5.8l0.4,0.6l-4,4.9l3,3l4.9-4l0.6,0.4     c1.8,1.2,3.7,2,5.8,2.4h0.8l0.1,0.9L29.9,55.1z"/></g><g><path d="M32,43.9c-6.6,0-11.9-5.3-11.9-11.9S25.4,20.1,32,20.1S43.9,25.4,43.9,32S38.6,43.9,32,43.9z M32,22.1     c-5.5,0-9.9,4.4-9.9,9.9s4.4,9.9,9.9,9.9s9.9-4.4,9.9-9.9S37.5,22.1,32,22.1z"/></g></g></g></svg></div> Light / Dark</a>
                </li>
            </ul>
        </nav>

    </header>

    <main class="main-wrapper">

        <header class="top-navbar">

            <div class="page-title">
                My Wallet
            </div>

            <form class="searchbar">
                <input type="search" name="" placeholder="Search...">
                <a href="#" class="js-close-bar">
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 54 67.5" version="1.1" x="0px" y="0px"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill="#ffffff" fill-rule="nonzero"><path d="M0.738461538,53.2615385 C1.10769231,53.6307692 1.56923077,53.8153846 2.07692308,53.8153846 C2.58461538,53.8153846 3.04615385,53.6307692 3.41538462,53.2615385 L27,29.6769231 L50.5846154,53.2615385 C50.9538462,53.6307692 51.4153846,53.8153846 51.9230769,53.8153846 C52.3846154,53.8153846 52.8923077,53.6307692 53.2615385,53.2615385 C54,52.5230769 54,51.3230769 53.2615385,50.5846154 L29.6769231,27 L53.2615385,3.41538462 C54,2.67692308 54,1.47692308 53.2615385,0.738461538 C52.5230769,-8.60422844e-16 51.3230769,-8.60422844e-16 50.5846154,0.738461538 L27,24.3230769 L3.41538462,0.738461538 C2.67692308,-2.77555756e-17 1.47692308,-2.77555756e-17 0.738461538,0.738461538 C-2.77555756e-17,1.47692308 -2.77555756e-17,2.67692308 0.738461538,3.41538462 L24.3230769,27 L0.738461538,50.5846154 C-2.77555756e-17,51.3230769 -2.77555756e-17,52.5230769 0.738461538,53.2615385 Z"/></g></g></svg>
                </a>
            </form>

            <nav class="navbar-top">
                <ul>
                    <li>
                        <a href="#"><svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" version="1.1" x="0px" y="0px" viewBox="0 0 100 125"><g transform="translate(0,-952.36218)"><path style="text-indent:0;text-transform:none;direction:ltr;block-progression:tb;baseline-shift:baseline;color:#fff;enable-background:accumulate;" d="m 71,964.36218 c -6.60369,0 -12,5.39626 -12,12 0,1.569 0.29072,3.0923 0.84375,4.4688 l -22.8125,12.6562 c -2.13154,-1.9311 -4.9437,-3.125 -8.03125,-3.125 -6.60369,0 -12,5.3963 -12,12.00002 0,6.6037 5.39631,12 12,12 3.09975,0 5.92804,-1.1803 8.0625,-3.125 l 22.8125,12.6562 c -0.5623,1.3864 -0.875,2.886 -0.875,4.4688 0,6.6037 5.39631,12 12,12 6.60369,0 12,-5.3963 12,-12 0,-6.6038 -5.39631,-12 -12,-12 -3.59539,0 -6.82772,1.6018 -9.03125,4.125 L 39.5625,1008.0497 c 0.91769,-1.6941 1.4375,-3.634 1.4375,-5.6875 0,-2.0637 -0.51137,-3.98752 -1.4375,-5.68752 l 22.40625,-12.4375 c 2.20362,2.526 5.43355,4.125 9.03125,4.125 6.60369,0 12,-5.3963 12,-12 0,-6.60374 -5.39631,-12 -12,-12 z m 0,4 c 4.44191,0 8,3.55804 8,8 0,4.442 -3.55809,8 -8,8 -4.44191,0 -8,-3.558 -8,-8 0,-4.44196 3.55809,-8 8,-8 z m -42,26 c 4.44191,0 8,3.558 8,8.00002 0,4.442 -3.55809,8 -8,8 -4.44191,0 -8,-3.558 -8,-8 0,-4.44202 3.55809,-8.00002 8,-8.00002 z m 42,26.00002 c 4.44191,0 8,3.558 8,8 0,4.4419 -3.55809,8 -8,8 -4.44191,0 -8,-3.5581 -8,-8 0,-4.442 3.55809,-8 8,-8 z" fill="#fff" fill-opacity="1" stroke="none" marker="none" visibility="visible" display="inline" overflow="visible"/></g></svg></a>
                    </li>

                    <li class="js-open-bar">
                        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 125" enable-background="new 0 0 100 100" xml:space="preserve"><g><circle fill="none" stroke="#ffffff" stroke-width="3" stroke-miterlimit="10" cx="59.1" cy="39.7" r="37.6"/><rect x="-1.7" y="80.3" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -52.2955 37.5849)" stroke="#ffffff" stroke-miterlimit="10" width="41.9" height="3.2"/></g></svg></a>
                    </li>

                    <li class="menu-toggle">
                        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" viewBox="0 0 100 125" enable-background="new 0 0 100 100" xml:space="preserve"><g><g><path d="M4.667,82.982H95v-6.018H4.667V82.982z M4.667,52.895H95v-6.018H4.667V52.895z M4.667,19.798v6.018H95v-6.018H4.667z"/></g></g></svg></a>
                    </li>
                </ul>
            </nav>

        </header>

        <section id="section1" class=" works smooth-in">


            <div id="section1-content" class="content" >

                <div class="left-side">

                    <!-- wallet icon -->
                    <div class="wallet-container floating-item">
                        <div class="wallet_outer">
                            <div class="leftshade"></div>
                            <div class="leftshadecover"></div>
                            <div class="rightshade"></div>
                            <div class="rightshadecover"></div>
                            <div class="cover"></div>
                            <div class="cover2"></div>
                            <div class="cover3"></div>
                            <div class="cash_behind"></div>
                            <div class="cash_behind_left"></div>
                            <div class="cash_behind_cover"></div>
                            <div class="cash_front"></div>
                            <div class="cash_front_left"></div>
                            <div class="cash_front_right"></div>
                            <div class="cash_front_cover"></div>
                            <div class="buckledropshade"></div>
                            <div class="buckle">
                                <div class="buckleshade"></div>
                                <div class="buckleshadecover"></div>
                                <div class="clip"></div>
                            </div>
                        </div>
                    </div>

                    <div class="wallet-balance" th:text="${loggedUserWallet.getBalance()} + '$'"></div>
                    <div class="buttons">
                        <div class="transaction-button deposit" id="deposit-button">
                            <i class="fa-solid fa-circle-arrow-up"></i>
                            <div class="button-text">Deposit</div>
                        </div>
                        <div class="transaction-button send" id="send-button">
                            <i class="fa-solid fa-circle-arrow-down"></i>
                            <div class="button-text">Send</div>
                        </div>
                    </div>
                </div>

                <div class="right-side">

                    <table>
                        <thead>
                        <tr class="head-row">
                            <th class="first-th col">Type</th>
                            <th class="col">Sender</th>
                            <th class="col">Recipient</th>
                            <th class="col">Direction</th>
                            <th class="col">Amount</th>
                            <th class="col">Created</th>
                            <th class="last-th col">Status</th>
                        </tr>
                        </thead>

                        <tbody class="transactions">

                        </tbody>

                    </table>


                    <div style="display: flex; gap: 3px" id="page-buttons">
                        <div style="padding: 3px">1</div>
                        <div style="padding: 3px">2</div>
                    </div>

                    <div class="pagination-buttons">
                        <button class="paginate left"><i></i><i></i></button>
                        <div class="counter"></div>
                        <button class="paginate right"><i></i><i></i></button>
                    </div>

                </div>
            </div>
            <div class="popup center">
                <div class="modal-header">
                    <small id="modal-header-title" style="font-size: 32px;place-self: center;">Deposit</small>
                    <div class="icon">
                        <i id="i-icon">icon</i>
                    </div>
                </div>

                <div class="modal-deposit-info info-active">
                    <div class="title">amount</div>
                    <div class="modal-content">
                        <input class="input" id="deposit-amount">
                    </div>
                </div>

                <div class="modal-send-info">
                    <div class="modal-content">
                        <div class="title">username</div>
                        <input class="input" id="recipient-email">
                        <div class="title">amount</div>
                        <input class="input" id="amount-to-send">

                    </div>
                </div>


                <div class="circle-loader hidden">
                    <div class="checkmark draw"></div>
                </div>

                <div class="successful-transaction-req">Deposit Successful !</div>

                <div class="button-container">
                    <a class="confirm-button" href="#">Do something risky.</a>
                </div>

                <div class="dismiss-btn">
                    <button id="dismiss-popup-btn">X</button>
                </div>
            </div>
        </section>

        <footer>

            <nav class="footer-nav">
                <ul>
                    <li>
                        <a href="#"><i class="fab fa-facebook-square"></i></a>
                    </li>
                    <li>
                        <a href="#"><i class="fab fa-dribbble-square"></i></a>
                    </li>
                    <li>
                        <a href="#"><i class="fab fa-codepen"></i></a>
                    </li>
                    <li>
                        <a href="#"><i class="fab fa-github-square"></i></a>
                    </li>
                    <li>
                    </li>
                </ul>
            </nav>

        </footer>

    </main>
</div>


<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

<script>

    const loggedUserId = Number (document.querySelector("#user-id").textContent);
    const pageSize = 10;
    let totalTransactionPages;

    getAndLoadContent(pageSize, 1).then(
        response => initializePaginationArrows())

    $("#page-buttons").on('click', function (e) {
        e.preventDefault();
        let pageNumber = Number (e.target.innerHTML);

        const activePage = $(".active-page").element

        getAndLoadContent(pageSize, pageNumber)
    })

    function getAndLoadContent(size, page) {
        return $.ajax({
            url: `/api/transactions/my-wallet`,
            type: "GET",
            dataType: "json",
            data: {size: size, page: page},

            success: function (response) {

                totalTransactionPages = response.totalPages
                const tableContent = $(".transactions").empty();

                response.content.forEach( function (transaction) {

                    let transactionType = lowercaseWord(transaction.transactionType)
                    let senderName;
                    let recipientName;
                    let transactionDirection;
                    let transactionAmount = transaction.amount;
                    let transactionCreationTime = transaction.creationTime;
                    let transactionStatus = lowercaseWord(transaction.status);

                    if (transaction.senderWallet.owner.id === loggedUserId) {
                        senderName = 'me'
                        recipientName = transaction.recipientWallet.owner.firstName;
                        transactionDirection =  'outgoing'
                    } else {
                        senderName = transaction.senderWallet.owner.firstName;
                        recipientName = "me"
                        transactionDirection = "incoming";
                    }

                    let statusClass;
                    if (transactionStatus === "completed") {
                        statusClass = 'status-completed'
                    }
                    else if (transactionStatus === "pending") {
                        statusClass = 'status-pending'
                    }
                    else {
                        statusClass = 'status-rejected'
                    }

                    let toAppend = "<small" + " class=`" + transactionDirection + "'>" +
                         transactionDirection +
                        "</small>"
                    let toAppendSender = "<small>" + senderName + "</small>"
                    let toAppendRecipient = "<small>" + recipientName + "</small>"
                    let toAppendStatus = "<small" + " class='" + statusClass + "'>" + transactionStatus +"</small>"

                    tableContent.append(
                        " <tr class='row'>" +
                            ' <td class="col first-col">' +
                                '<small>' + transactionType + '</small>' +
                            '</td>' +
                            '<td class="col">' + toAppendSender +  "</td>" +
                            '<td class="col"' + toAppendRecipient +
                            '<td class="col">' +
                                toAppend +
                            '</td>' +

                            '<td class="col">' +
                                '<small>' + transactionAmount + '</small> ' +
                            '</td>' +
                            '<td class="col">' +
                                '<small class="transaction-creation-date">' + transactionCreationTime +'</small>' +
                            '</td>' +
                            '<td class="col last-col">' +
                                toAppendStatus +
                            '</td>' +
                         '</tr>'
                    )

                })

            },

            error: function (response) {
                console.log("error")
            }

        })
    }

    function lowercaseWord(string) {
        return string.toLowerCase()
    }


    var pr = document.querySelector( '.paginate.left' );
    var pl = document.querySelector( '.paginate.right' );

    function initializePaginationArrows() {


        pr.onclick = slide.bind( this, -1 );
        pl.onclick = slide.bind( this, 1 );

        var index = 0, total = totalTransactionPages;

        function slide(offset) {
            index = Math.min( Math.max( index + offset, 0 ), total - 1 );

            document.querySelector( '.counter' ).innerHTML = ( index + 1 ) + ' / ' + total;

            getAndLoadContent(10, index + 1);

            pr.setAttribute( 'data-state', index === 0 ? 'disabled' : '' );
            pl.setAttribute( 'data-state', index === total - 1 ? 'disabled' : '' );
        }
        slide(0);
    }

</script>

<script>
    const $depositButton = document.querySelector("#deposit-button");
    const $modalContainer = document.querySelector("#section1-content")
    const $depositInfo = document.querySelector(".modal-deposit-info")
    const $sendInfo = document.querySelector(".modal-send-info")
    const $transactionButtons = document.querySelector(".buttons")
    let $activeModalBody = document.querySelector(".info-active");
    const $completedLoadMessage = document.querySelector(".successful-transaction-req")
    const $modalTitle = document.querySelector("#modal-header-title")

    const activeClass = 'info-active'

    $transactionButtons.addEventListener("click", e => {
        e.preventDefault();
        let buttonClicked = e.target

        $activeModalBody.classList.remove(activeClass)
        $modalContainer.classList.add("blur")
        document.getElementsByClassName("popup")[0].classList.add("active")

        let classList = buttonClicked.classList;
        if (classList.contains('fa-solid') || classList.contains('button-text')) {
            buttonClicked = buttonClicked.parentElement
            classList = buttonClicked.classList;
        }

        if (classList.contains('deposit')) {
            $modalTitle.innerHTML = "Deposit"
            $depositInfo.classList.add(activeClass)
        }
        else if (classList.contains("send")) {
            $modalTitle.innerHTML = "Send"
            $sendInfo.classList.add(activeClass)
        }
        else if (classList.contains("inventory")) {
            //todo
        }

    })

    // $depositButton.addEventListener('click', function(e) {
    //     e.preventDefault();
    //     $modalContainer.classList.add("blur")
    //     document.getElementsByClassName("popup")[0].classList.add("active")
    //     // window.location = '/wallets/deposit'
    // })

    document.getElementById("dismiss-popup-btn").addEventListener("click", function (e){

        const activeInfo = document.querySelector(`.${activeClass}`)

        document.getElementsByClassName("popup")[0].classList.remove("active")
        $modalContainer.classList.remove("blur")
        hideLoadingSpinner()

        if (activeInfo !== null) {
            activeInfo.classList.remove(activeClass)
        }
    });

    var oldText;
    const $loadingSpinner = document.querySelector(".circle-loader")

    confirm = $('.confirm-button');

    $(".confirm-button").click(function(e) {
        e.preventDefault()
        var b = $(this);
        if (b.hasClass("confirm")) {
            b.text("Thanks!");
            b.removeClass("confirm");
            b.addClass("done");
            showLoadingSpinner();

            setTimeout(function() {
                b.removeClass("done");
                b.text(oldText);
                $completedLoadMessage.style.opacity = 1
            }, 4000);

        } else if (b.hasClass("done")) {
            return;

        } else {
            oldText = b.text();
            $(this).addClass("confirm");
            $(this).text("Are you sure?")

            setTimeout(function() {
                if (!b.hasClass("done")) {
                    b.removeClass("confirm");
                    b.text(oldText);

                    //TODO: Make modal reset and close after 8 seconds

                }
            }, 8000);
        }
    })


    function showLoadingSpinner() {
        $activeModalBody = $(".info-active")[0];
        if ($activeModalBody !== null) {
            $activeModalBody.classList.remove("info-active");
        }

        $loadingSpinner.classList.remove("hidden")

        setTimeout(function () {
            $('.circle-loader').toggleClass('load-complete');
            $('.checkmark').toggle();
        }, 3000)

    }

    function hideLoadingSpinner() {
        $loadingSpinner.classList.add("hidden")
        $('.circle-loader').toggleClass('load-complete')
        $('.checkmark').toggle();
    }
</script>


<script>



</script>


<!-- TODO TEST -->

</body>
</html>